---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(car)
```


```{r}
df <- read.csv("Data/df_clean_more_features.csv")

getvar <- function()

dfuk <- df[df$cntry == "United Kingdom", ]
```

```{r}
#dftot <- read.csv("Data/ESS11.csv")
dftotuk <- dftot[dftot$cntry == "GB", ]

dftotuk <- dftotuk[dftotuk$weighta <= 250, ]
dftotuk <- dftotuk[dftotuk$fltdpr < 4, ]

dftotuk %>% 
  select(gndr, weighta, fltdpr) %>% 
  mutate(gndr = factor(gndr, levels = c(1, 2), labels = c("Male", "Female"))) %>% 
  t.test(data = ., weighta ~ gndr)

# t(1296) = 18.571, p-value < 2.2e-16 -> this rejects the null hypothesis
```
```{r}
library(effsize)
cohen.d(df$weighta, df$gndr)

cohen.d(fem, mal)

```


```{r}
dfmale <- dftotuk[dftotuk$gndr == 1, ]
dffemale <- dftotuk[dftotuk$gndr == 2, ]

#fem <- dffemale[, c("weighta", "fltdpr")]
#mal <- dfmale[, c("weighta", "fltdpr")]

fem <- dffemale[, "weighta"]
mal <- dfmale[, "weighta"]
```

```{r}
df <- dftotuk[c("gndr", "weighta", "fltdpr")]

df$gndr <- factor(df$gndr, levels = c(1, 2), labels = c("Male", "Female"))

df %>% 
  group_by(gndr) %>% 
  summarise(n())

ggplot(data = df, aes(x = weighta, fill = gndr)) + geom_area(stat = "density", alpha = 0.5) + scale_fill_manual(values = c("Female" = "green", "Male" = "blue"))
```


```{r}
cor(df$weighta, df$fltdpr)
```
Levene's Test of homogeneity
```{r}
leveneTest(data = df, weighta ~ gndr)
# p > 0.5 so variances are roughly equal between groups
```


```{r}
df



```


```{r}
dfmale <- dfuk[dfuk$gndr == "Male", ]
dffemale <- dfuk[dfuk$gndr == "Female", ]

dfuk
```

```{r}
#Call ggplot
library(ggplot2)

#Make the plot
ggplot(data = dfmale, aes(x = cgtsmok)) + 
  geom_histogram()

shapiro.test(dfmale$cgtsmok)
```

```{r}

dfpt <- read.csv('ess_allyr_multi.csv')
unique(dfpt$name)

```

```{r}
df <- dfpt %>% 
  mutate(name = case_when(
    name == "ESS1e06_7" ~ "2002",
    name == "ESS2e03_6" ~ "2004",
    name == "ESS3e03_7" ~ "2006",
    name == "ESS4e04_6" ~ "2008",
    name == "ESS5e03_5" ~ "2010",
    name == "ESS6e02_6" ~ "2012",
    name == "ESS7e02_3" ~ "2014",
    name == "ESS8e02_3" ~ "2016",
    name == "ESS9e03_2" ~ "2018",
    name == "ESS10e03_2" ~ "2020",
    name == "ESS11e02" ~ "2023"
  ))
```


```{r}
dfhappy <- df %>% 
  select(name, happy) %>% 
  filter(happy <= 10) %>% 
  group_by(name, happy) %>% 
  summarise(qty = n(), .groups = "drop") %>% 
  group_by(name) %>% 
  mutate(perc = round((qty / sum(qty)) * 100, 1))
  #mutate(perc = mutate(qty/sum(qty)) *100)

dfhappy
```


```{r}
dfhappy2 <- df %>% 
  select(name, happy) %>% 
  filter(happy <= 10) %>% 
  group_by(name, happy) %>% 
  summarise(qty = n(), .groups = "drop") %>% 
  group_by(name) %>% 
  mutate(perc = round((qty / sum(qty)) * 100, 1)) %>% 
  mutate(accum_freq = cumsum(perc)) %>% 
  mutate(accum_freq = ifelse(row_number() == n(), 100, accum_freq)) # Set last row to 100
  
dfhappy2
```


```{r}
ggplot(dfhappy, aes(x = happy, y = perc, color = name, group = name)) +
  geom_line(size = 1) + # Lines for each year
  geom_point(size = 2) + # Points for better visibility
  labs(
    title = "Distribution of Happiness Scores by Year",
    x = "Happiness Score",
    y = "Percentage",
    color = "Year"
  ) +
  scale_x_continuous(breaks = 0:10) + # Show all happiness values on x-axis
  theme_minimal()
```
```{r}
library(plotly)
# Interactive Plot with Plotly

plot <- dfhappy %>%
  plot_ly(
    x = ~happy,
    y = ~perc,
    color = ~name,
    type = 'scatter',
    mode = 'lines+markers',
    text = ~paste("Year:", name, "<br>Happy:", happy, "<br>Percentage:", perc, "%")
  ) %>%
  layout(
    title = "Distribution of Happiness Scores by Year",
    xaxis = list(title = "Happiness Score", tickvals = 0:10),
    yaxis = list(title = "Percentage"),
    legend = list(title = list(text = "Year"))
  )

plot
```

```{r}
plot <- dfhappy %>%
  plot_ly(
    x = ~happy,
    y = ~perc,
    color = ~name,
    type = 'scatter',
    mode = 'lines',
    fill = 'tonexty', # Fills area below the line
    text = ~paste("Year:", name, "<br>Happy:", happy, "<br>Percentage:", perc, "%")
  ) %>%
  layout(
    title = "Distribution of Happiness Scores by Year",
    xaxis = list(title = "Happiness Score", tickvals = 0:10),
    yaxis = list(title = "Percentage"),
    legend = list(title = list(text = "Year"))
  )

plot
```
```{r}
df <- read.csv("Data/ess_allyr_multi.csv")

df
```

```{r}
df <- df %>% 
  mutate(name = case_when(
    name == "ESS1e06_7" ~ "2002",
    name == "ESS2e03_6" ~ "2004",
    name == "ESS3e03_7" ~ "2006",
    name == "ESS4e04_6" ~ "2008",
    name == "ESS5e03_5" ~ "2010",
    name == "ESS6e02_6" ~ "2012",
    name == "ESS7e02_3" ~ "2014",
    name == "ESS8e02_3" ~ "2016",
    name == "ESS9e03_2" ~ "2018",
    name == "ESS10e03_2" ~ "2020",
    name == "ESS10SCe03_1" ~ "2020",
    name == "ESS11e02" ~ "2023"
  ))
```

```{r}
dfhappy2023 <- df %>% 
  filter(name == "2023") %>% 
  select(cntry, happy) %>% 
  filter(happy <= 10) %>% 
  group_by(cntry, happy) %>% 
  summarise(qty = n(), .groups = "drop") %>% 
  group_by(cntry) %>% 
  mutate(perc = round((qty / sum(qty)) * 100, 1)) %>% 
    mutate(accum_freq = cumsum(perc)) %>% 
  mutate(accum_freq = ifelse(row_number() == n(), 100, accum_freq)) # Set last row to 100

dfhappy2023
```

```{r}
plot <- dfhappy2023 %>%
  plot_ly(
    #x = ~happy,
    #y = ~perc,
    y = ~happy,
    x = ~perc,
    color = ~cntry,
    type = 'scatter',
    #mode = 'lines',
    mode = 'lines+markers',
    #fill = 'tonexty', # Fills area below the line
    text = ~paste("Country:", cntry, "<br>Happy:", happy, "<br>Percentage:", perc, "%")
  ) %>%
  layout(
    title = "Distribution of Happiness Scores by Country in 2023",
    xaxis = list(title = "Happiness Score", tickvals = 0:100),
    yaxis = list(title = "Percentage"),
    legend = list(title = list(text = "Country"))
  )

plot
```

```{r}

# Assuming dfhappy2023 is already created
plot <- dfhappy2023 %>%
  plot_ly(
    x = ~perc, # Percentages on the x-axis
    y = ~cntry, # Countries on the y-axis
    color = ~happy, # Color by level of happiness
    type = 'bar', # Bar chart
    orientation = 'h', # Horizontal bars
    #text = ~paste("Country:", cntry, "<br>Happy Level:", happy, "<br>Percentage:", perc, "%"),
    #hoverinfo = 'text' # Custom hover info
    #text = ~happy, # Display only happiness level on the graph
    hoverinfo = 'text', # Maintain hover information
    hovertext = ~paste("Country:", cntry, "<br>Happy Level:", happy, "<br>Percentage:", perc, "%") # Detailed hover info
  ) %>%
  layout(
    barmode = 'stack', # Stacked bars
    title = "Happiness Distribution by Level Across Countries (2023)",
    xaxis = list(title = "Percentage"),
    yaxis = list(title = "Country"),
    legend = list(title = list(text = "Happiness Level"))
  )

plot

unique(dfhappy$cntry)
```

```{r}

plot <- dfhappy2023 %>%
  plot_ly(
    x = ~cntry, # Percentages on the x-axis
    y = ~perc, # Countries on the y-axis
    color = ~happy, # Color by level of happiness
    type = 'bar', # Bar chart
    #orientation = 'h', # Horizontal bars
    #text = ~paste("Country:", cntry, "<br>Happy Level:", happy, "<br>Percentage:", perc, "%"),
    #hoverinfo = 'text' # Custom hover info
    text = ~happy, # Display only happiness level on the graph
    hoverinfo = 'text', # Maintain hover information
    hovertext = ~paste("Country:", cntry, "<br>Happy Level:", happy, "<br>Percentage:", perc, "%") # Detailed hover info
  ) %>%
  layout(
    barmode = 'stack', # Stacked bars
    title = "Happiness Distribution by Level Across Countries (2023)",
    xaxis = list(title = "Percentage"),
    yaxis = list(title = "Country"),
    legend = list(title = list(text = "Happiness Level"))
  )

plot

```

```{r}
op_cntry1 <- 'NL'
op_cntry2 <- 'PT'

op_df <- dfhappy2023 %>% 
  filter(cntry == op_cntry1 | cntry == op_cntry2 | cntry == 'HU' | cntry == 'FR') %>% 
  mutate(accum_freq = cumsum(perc)) %>% 
  mutate(accum_freq = ifelse(row_number() == n(), 100, accum_freq)) # Set last row to 100

op_df
```


```{r}

# Create the Plotly graph
plot <- op_df %>%
  plot_ly(
    x = ~happy,                # Happiness levels as the x-axis
    y = ~perc,                 # Percentage values as the y-axis
    color = ~cntry,            # Different colors for each country
    type = 'bar',              # Bar chart type
    barmode = 'group',         # Grouped bars (side-by-side)
    text = ~paste(
      "Country:", cntry, 
      "<br>Happiness score:", happy, 
      "<br>Percentage:", perc, "%",
      "<br>Accumulated Frequency:", accum_freq, "%"
    ),                         # Hover information with details
    hoverinfo = 'text'         # Enable hover with custom text
  ) %>%
  layout(
    title = "Happiness Levels by Country",     # Chart title
    xaxis = list(title = "Happiness Level"),   # X-axis label
    yaxis = list(title = "Percentage"),        # Y-axis label
    legend = list(title = list(text = "Country")) # Legend title
  )

plot


```

```{r}
plot <- plot_ly() %>%
  add_trace(
    data = op_df,
    x = ~happy,
    y = ~perc,
    color = ~cntry,
    type = 'bar',
    barmode = 'group',
    #name = 'Percentage',
    text = ~paste0(
      "Country:", cntry, 
      "<br>Happiness Score:", happy, 
      "<br>Percentage:", perc, "%",
      "<br>Accumulated Frequency:", accum_freq, "%"),  # Hover information with details
    hoverinfo = 'text', textposition = 'none') %>%   # Enable hover with custom text

  add_trace(
    data = op_df,
    x = ~happy,
    y = ~accum_freq,
    color = ~cntry,
    type = 'scatter',
    mode = 'lines+markers',
    #name = 'Cumulative Frequency',
    text = ~paste("Country:", cntry, 
      "<br>Happy Level:", happy, 
      "<br>Percentage:", perc, "%",
      "<br>Accumulated Frequency:", accum_freq, "%"),  # Hover information with details
    hoverinfo = 'text', textposition = 'none') %>% 

  layout(
    title = "Grouped Bar Chart with Cumulative Line",
    xaxis = list(title = "Happiness Scores"),
    yaxis = list(title = "Percentage"),
    legend = list(title = list(text = "Country"))
  )

plot

```
```{r}
df <- read.csv("Data/ess_allyr_multi.csv")

df <- df %>%
  mutate(name = case_when(
    name == "ESS1e06_7" ~ "2002",
    name == "ESS2e03_6" ~ "2004",
    name == "ESS3e03_7" ~ "2006",
    name == "ESS4e04_6" ~ "2008",
    name == "ESS5e03_5" ~ "2010",
    name == "ESS6e02_6" ~ "2012",
    name == "ESS7e02_3" ~ "2014",
    name == "ESS8e02_3" ~ "2016",
    name == "ESS9e03_2" ~ "2018",
    name == "ESS10e03_2" ~ "2020",
    name == "ESS10SCe03_1" ~ "2020",
    name == "ESS11e02" ~ "2023"
  ))


dfhappy <- df %>%
  select(name, cntry, happy) %>%
  filter(happy <= 10) %>%
  group_by(name, cntry, happy) %>% 
  summarise(qty = n(), .groups = "drop") %>%
  group_by(name, cntry) %>%
  mutate(perc = round((qty / sum(qty)) * 100, 1))
```

```{r}
dfhappy2023all <- dfhappy %>% 
  filter(happy == 5, name == '2023') %>% 
  arrange(desc(perc)) 

plot_ly(data = dfhappy2023all, x = ~reorder(cntry, -perc), y = ~perc, type = 'bar')
```

```{r}
filtered <- dfhappy %>%
      filter(cntry == c('NL', 'PT'), name == '2023') %>%
      group_by(cntry) %>%
      mutate(accum_freq = cumsum(perc)) %>%
      mutate(accum_freq = ifelse(row_number() == n(), 100, accum_freq)) # Ensure last value = 100
    
    # Calculate metrics relative to happiness level 5
metrics <- filtered %>%
      filter(happy == 5) %>%
      mutate(towards_unhappy = accum_freq,
        towards_happy = 100 - accum_freq)
    
  metrics
```


```{r}
happy_health <- df %>% 
  select(cntry, happy, health) %>% 
  filter(happy <= 10, health <= 5, cntry == 'PT')

happy_health
```


```{r}
plot_ly(data = happy_health, x = ~happy_health$happy, ) #, y = ~happy_health$health)
  
```

